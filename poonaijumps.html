<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZIM - Code Creativity</title>

    <!-- zimjs.com - JavaScript Canvas Framework -->
    <script type="module">
      import zim from "https://zimjs.org/cdn/016/zim_physics";

      // See Docs under Frame for FIT, FILL, FULL, and TAG
      const assets = [
        "poonai1.png",
        "poonai2.png",
        "poonai3.png",
        "poonai4.png",
        "poonai5.png",
        "catboo.ttf",
        "flames.png",
        "meow.ogg",
      ];
      const path = "assets/";
      new Frame(FIT, 1920, 1080, interstellar, dark, ready, assets, path);
      async function ready() {
        // given F (Frame), S (Stage), W (width), H (height)
        // put code here
        const fragmentResponse = await fetch("/shaders/halo.frag");
        const fragment = await fragmentResponse.text();

        const fragmentResponse2 = await fetch("/shaders/halo2.frag");
        const fragment2 = await fragmentResponse2.text();

        // const infernoResponse = await fetch('/shaders/inferno.frag');
        // const infernoFrag = await infernoResponse.text();
        // const inferno = new Shader(W, 250, infernoFrag).loc(0, H-0.1*H);

        const flames = new Pic("flames.png")
          .sca(1.2)
          .pos(0, -10, CENTER, BOTTOM);
        const circleContainer = new Container(W - 150, H - 150)
          .centerReg()
          .pos(50, 100, LEFT, BOTTOM);
        const circleMask = new Circle(150, "gray")
          .centerReg()
          .pos(100, 0, LEFT, CENTER, circleContainer)
          .ord(-1)
          .alp(0.2);
        const halo = new Shader(W, H, fragment)
          .centerReg()
          .pos(555, 0, RIGHT, CENTER, circleContainer)
          .ord(2);
        halo.sca(0.39);
        circleContainer.sca(0.7);

        const circleContainer2 = new Container(W - 150, H - 150)
          .centerReg()
          .pos(100, 100, RIGHT, BOTTOM)
          .sca(1)
          .drag({ all: true });
        const circleMask2 = new Circle(150, "gray")
          .centerReg()
          .pos(100, 0, RIGHT, CENTER, circleContainer2)
          .ord(-1)
          .alp(0.2);
        const haloCatch = new Shader(W, H, fragment2)
          .centerReg()
          .pos(555, 0, LEFT, CENTER, circleContainer2)
          .ord(2);
        haloCatch.sca(0.39);
        // circleContainer2.sca(0.8).outline();

        // const poonaiCatcher = new Container(W - 150, H - 150)
        //   .reg(CENTER)
        //   .pos(100, 0, LEFT, CENTER)
        //   .sca(1)
        //   .drag({ all: true });
        // const catcherMask = new Circle(150, "gray")
        //   .pos(100,0,LEFT, CENTER, poonaiCatcher)
        //   .ord(-1)
        //   .alp(0.2);
        // const catcherShader = new Shader(W, H, fragment)
        //   .centerReg()
        //   .pos(-100,100,LEFT, BOTTOM, poonaiCatcher)
        //   .ord(2);
        // catcherShader.sca(0.39);

        const poonai1 = new Pic("poonai1.png").centerReg().vis(false);
        const poonai2 = new Pic("poonai2.png").centerReg().vis(false);
        const poonai3 = new Pic("poonai3.png").centerReg().vis(false);
        const poonai4 = new Pic("poonai4.png").centerReg().vis(false);
        const poonai5 = new Pic("poonai5.png").centerReg().vis(false);

        const poonais = [poonai1, poonai2, poonai3, poonai4, poonai5];

        // let xRand = rand(180,400);
        // let yRand = rand(-150,-400);
        const xImp = series(
          rand(180, 220),
          rand(80, 100),
          rand(400, 450),
          rand(250, 220),
          rand(300, 520)
        );
        const yImp = series(
          rand(-180, -150),
          rand(-50, -100),
          rand(-400, -300),
          rand(-250, -125),
          rand(-300, -500)
        );
        loop(
          poonais,
          (poonai) => {
            poonai.pos(410, 0, LEFT, CENTER);
            poonai.addPhysics({
              bounciness: 0.5,
              linear: 0.3,
              shape: "circle",
            });

            poonai.impulse(xImp(), rand(-150, -400));
            // poonai.impulse(xRand, yRand);
            // poonai.sca(0.3);
            poonai.vis(true);
            // poonai.drag();
            circleContainer2.on("pressmove", () => {
              //instructions.removeFrom();
              if (poonai.hitTestCircle(haloCatch)) {
                zog("catch");
                poonai.dispose();
                scorer.score++;
                S.update();
              }
            });
            // flames.on("tick", () => {
            //   if (poonai.hitTestRect(flames)) {
            //     S.removeChild(poonai);
            //     S.update();
            //   }
            // });
          },
          null,
          2
        );

        const instructions = new Label({
          text: "Drag the circle to save the poonais",
          size: 25,
          font: "catboo",
          color: "white",
        }).pos(250, 270, RIGHT, TOP);

        let explodeBool = false;
        Ticker.add(poonaiRemover);
        function poonaiRemover() {
          loop(
            poonais,
            (poonai) => {
              if (poonai.y >= H - 100) {
                zog("burn");
                let px = poonai.x;
                let py = poonai.y;
                explosion(px, py);
                poonai.dispose();
                S.update();
              }
              // else if (poonai.hitTestCircle(circleContainer2)) {
              //   zog("catch");
              //   poonai.dispose();
              //   S.update();
              // }
            },
            true
          );
        }

        function explosion(px, py) {
          const emitter = new Emitter(new Circle(5, ["#FF97FF", "#00CCFF"]))
            .loc(px, py)
            .sca(1)
            .spurt(5, 1);
          timeout(3, () => {
            emitter.dispose();
            S.update();
            explodeBool = false;
          });
        }

        loop(poonais, (poonai) => {});

        // UI
        const poonaisSaved = new Label({
          text: "Poonais Saved:",
          size: 32,
          font: "catboo",
          color: "white",
        }).pos(200, 60, RIGHT, TOP);
        const timeLeft = new Label({
          text: "Time Left:",
          size: 32,
          font: "catboo",
          color: "white",
        }).pos(80, 60, LEFT, TOP);
        var scorer = new Scorer({
          backgroundColor: "#D1007D",
          color: white,
          font: "catboo",
          isometric: false,
        }).loc(W - 120, 80);
        scorer.score = 0;
        scorer.sca(0.8);
        // new Timer({time:60,borderColor:dark,isometric:LEFT}).loc(W-100,100);
        const timer = new Container(200, 200).pos(230, 5, LEFT, TOP).sca(0.7);
        const timerBG = new Rectangle(150, 80, "#D1007D").center(timer);
        const timerText = new Label({
          text: "60",
          size: 38,
          font: "catboo",
          color: "white",
        }).center(timer);
        interval(1, () => {
          timerText.text--;
        });
        // Ticker.add(poonaijump);
        // function poonaijump() {
        //   poonai1.force(40, 40, poonai1.x, poonai1.y);
        // }
        // Ticker.remove(poonaijump);
      } // end ready
    </script>
    <meta name="viewport" content="width=device-width, user-scalable=no" />
  </head>
  <body></body>
</html>
